<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>GLOBGM Data Code Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bs-body-font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --bs-body-bg: #fff;
      --bs-body-color: #212529;
      --bs-link-color: #2780e3;
      --bs-link-hover-color: #1967c2;
      --bs-border-color: #dee2e6;
      --bs-secondary-bg: #f8f9fa;
      --bs-code-bg: #ffffff;
      --bs-code-color: #e83e8c;
      --heading-color: #343a40;
    }
    
    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      font-family: var(--bs-body-font-family);
      font-size: 1rem;
      line-height: 1.6;
      color: var(--bs-body-color);
      background: var(--bs-body-bg);
    }
    
    main {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1.5rem;
      display: grid;
      gap: 2rem;
      grid-template-columns: 1fr 1fr;
    }
    
    h1, h2, h3 {
      margin-top: 0;
      margin-bottom: 0.75rem;
      font-weight: 600;
      line-height: 1.2;
      color: var(--heading-color);
    }
    
    h2 {
      font-size: 1.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--bs-border-color);
    }
    
    .card {
      background: var(--bs-body-bg);
      border: 1px solid var(--bs-border-color);
      border-radius: 0.375rem;
      padding: 1.5rem;
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      font-size: 0.95rem;
      color: var(--heading-color);
    }
    
    input, select {
      width: 100%;
      padding: 0.5rem 0.75rem;
      font-size: 1rem;
      border: 1px solid var(--bs-border-color);
      border-radius: 0.375rem;
      background: var(--bs-body-bg);
      color: var(--bs-body-color);
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    
    input:focus, select:focus {
      border-color: #86b7fe;
      outline: 0;
      box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    .row {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(2, 1fr);
      margin-bottom: 1rem;
    }
    
    .row3 {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(3, 1fr);
      margin-bottom: 1rem;
    }
    
    .help {
      margin-top: 0.25rem;
      font-size: 0.875rem;
      color: #6c757d;
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    .toolbar {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 1.5rem;
    }
    
    button {
      cursor: pointer;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      font-weight: 400;
      line-height: 1.5;
      border: 1px solid transparent;
      border-radius: 0.375rem;
      transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out;
    }
    
    button.primary {
      color: #fff;
      background-color: var(--bs-link-color);
      border-color: var(--bs-link-color);
    }
    
    button.primary:hover {
      background-color: var(--bs-link-hover-color);
      border-color: var(--bs-link-hover-color);
    }
    
    pre {
      margin: 0;
      padding: 1rem;
      background: var(--bs-code-bg);
      border: 1px solid var(--bs-border-color);
      border-radius: 0.375rem;
      overflow: auto;
      max-height: 550px;
      font-size: 0.875rem;
      line-height: 1.5;
    }
    
    code {
      font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, "Liberation Mono", monospace;
      color: var(--bs-body-color);
    }
    
    .error {
      color: #dc3545;
      font-size: 0.875rem;
      margin-top: 0.75rem;
      padding: 0.75rem;
      background-color: #f8d7da;
      border: 1px solid #f5c2c7;
      border-radius: 0.375rem;
    }
    
    .mono {
      font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, "Liberation Mono", monospace;
    }
    
    @media (max-width: 980px) {
      main { grid-template-columns: 1fr; }
      .row3 { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <main>
    <!-- Left: Form -->
    <section class="card">
      <h2>Dataset Selector</h2>

      <div class="form-group">
        <label>Dataset Type</label>
        <select id="datasetType">
          <option value="historical">Historical Reference (GSWP3-W5E5, 1960-2019)</option>
          <option value="cmip6" disabled>CMIP6 Scenarios (coming soon...)</option>
        </select>
      </div>

      <div class="row">
        <div class="form-group">
          <label>Variable</label>
          <select id="variable">
            <option value="hds">hds (hydraulic head)</option>
            <option value="wtd">wtd (water table depth)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Temporal Aggregation</label>
          <select id="temporal">
            <option value="average">Average (1960-2019 mean)</option>
            <option value="annual">Annual (yearly time series)</option>
            <option value="monthly">Monthly (monthly time series)</option>
          </select>
        </div>
      </div>

      <h2 style="margin-top: 2rem;">Spatial & Temporal Subset</h2>

      <div class="row3">
        <div class="form-group">
          <label>Lat min</label>
          <input id="latMin" type="number" step="0.01" min="-90" max="90" value="-60">
          <div class="help">Range: -90 to 90</div>
        </div>
        <div class="form-group">
          <label>Lat max</label>
          <input id="latMax" type="number" step="0.01" min="-90" max="90" value="60">
          <div class="help">Range: -90 to 90</div>
        </div>
        <div class="form-group">
          <label>Lon min</label>
          <input id="lonMin" type="number" step="0.01" min="-180" max="180" value="-180">
          <div class="help">Range: -180 to 180</div>
        </div>
      </div>

      <div class="row3">
        <div class="form-group">
          <label>Lon max</label>
          <input id="lonMax" type="number" step="0.01" min="-180" max="180" value="180">
          <div class="help">Range: -180 to 180</div>
        </div>
        <div class="form-group">
          <label>Years (optional)</label>
          <input id="years" class="mono" placeholder="e.g., 1980-2010">
          <div class="help">Only for annual/monthly data</div>
        </div>
        <div class="form-group">
          <label>Output format</label>
          <select id="outputFormat">
            <option value="netcdf">NetCDF</option>
            <option value="zarr">Zarr</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label>Output path (local)</label>
        <input id="outputPath" class="mono" placeholder="data/output.nc">
      </div>

      <div class="toolbar">
        <button class="primary" id="generate">Generate code</button>
        <span id="status" class="help"></span>
      </div>
      <div id="errors" class="error" style="display:none;"></div>
    </section>

    <!-- Right: Output -->
    <section class="card">
      <h2>Generated code</h2>
      <pre><code id="codeBlock">Select dataset options and click "Generate code"...</code></pre>
    </section>
  </main>

  <script>
    // URL Configuration for Historical Reference
    const URL_CONFIG = {
      historical: {
        baseUrl: "https://geo.public.data.uu.nl/vault-globgm-historical-reference-gswp3-w5e5/research-globgm-historical-reference-gswp3-w5e5%5B1754035745%5D/original/",
        
        build: function(variable, temporal) {
          // Pattern: {temporal}/{variable}_reference_gswp3-w5e5_{temporal}_1960_2019.nc
          const filename = `${variable}_reference_gswp3-w5e5_${temporal}_1960_2019.nc`;
          return `${this.baseUrl}${temporal}/${filename}`;
        }
      }
    };

    // Utilities
    const $ = (id) => document.getElementById(id);

    function updateURL() {
      const datasetType = $("datasetType").value;
      const variable = $("variable").value;
      const temporal = $("temporal").value;
      
      if (datasetType === "historical") {
        const url = URL_CONFIG.historical.build(variable, temporal);
        
        // Disable year filter for "average" temporal
        if (temporal === "average") {
          $("years").disabled = true;
          $("years").value = "";
          $("years").placeholder = "N/A for average data";
        } else {
          $("years").disabled = false;
          $("years").placeholder = "e.g., 1980-2010";
        }
        
        return url;
      }
      
      return "";
    }

    function validate() {
      const errs = [];
      const latMin = parseFloat($("latMin").value);
      const latMax = parseFloat($("latMax").value);
      const lonMin = parseFloat($("lonMin").value);
      const lonMax = parseFloat($("lonMax").value);
      
      if (Number.isNaN(latMin) || Number.isNaN(latMax)) errs.push("Lat min/max must be numbers.");
      if (Number.isNaN(lonMin) || Number.isNaN(lonMax)) errs.push("Lon min/max must be numbers.");
      
      // Validate coordinate ranges
      if (latMin < -90 || latMin > 90) errs.push("Lat min must be between -90 and 90.");
      if (latMax < -90 || latMax > 90) errs.push("Lat max must be between -90 and 90.");
      if (lonMin < -180 || lonMin > 180) errs.push("Lon min must be between -180 and 180.");
      if (lonMax < -180 || lonMax > 180) errs.push("Lon max must be between -180 and 180.");
      
      if (latMin > latMax) errs.push("Lat min must be <= lat max.");
      if (lonMin > lonMax) errs.push("Lon min must be <= lon max.");
      
      const years = $("years").value.trim();
      const temporal = $("temporal").value;
      if (years && temporal !== "average") {
        if (!/^\d{4}\s*-\s*\d{4}$/.test(years)) {
          errs.push("Years must be in form YYYY-YYYY (e.g., 1980-2010).");
        } else {
          const [start, end] = years.split("-").map(y => parseInt(y.trim()));
          if (start < 1960 || end > 2019) {
            errs.push("Years must be within 1960-2019 range.");
          }
        }
      }
      
      const out = $("outputPath").value.trim();
      if (!out) errs.push("Output path is required.");
      
      return errs;
    }

    // Python template
    function pyTemplate(data) {
      const { url, latMin, latMax, lonMin, lonMax, variable, years, out, fmt, temporal } = data;
      
      const yearsLine = (years && temporal !== "average") ? `
# Subset by time
time_slice = slice("${years.split("-")[0]}", "${years.split("-")[1]}")
ds = ds.sel(time=time_slice)` : "";

      const writeLine = fmt === "netcdf"
        ? `# Write NetCDF
ds.to_netcdf("${out}", encoding={var: {"zlib": True, "complevel": 4} for var in ds.data_vars})`
        : `# Write Zarr
ds.to_zarr("${out}", mode="w")`;

      return `# Generated by GLOBGM Data Code Generator
# Requirements: pip install xarray netcdf4 dask

import xarray as xr

url = "${url}"
lat_min, lat_max = ${latMin}, ${latMax}
lon_min, lon_max = ${lonMin}, ${lonMax}

# Open dataset
print(f"Opening: {url}")
ds = xr.open_dataset(url, chunks="auto")
print(f"Original dataset: {ds}")

# Spatial subset
# Note: latitude is typically decreasing (90 to -90)
ds = ds.sel(latitude=slice(lat_max, lat_min), longitude=slice(lon_min, lon_max))${yearsLine}

print(f"Subset dataset: {ds}")

# Load and write
print(f"Writing to: ${out}")
ds = ds.load()
${writeLine}

print("✓ Done!")`;
    }

    function generate() {
      const errs = validate();
      const errBox = $("errors");
      if (errs.length) {
        errBox.style.display = "block";
        errBox.textContent = "⚠ " + errs.join(" ");
        return;
      }
      errBox.style.display = "none";

      const url = updateURL();
      const data = {
        url: url,
        latMin: parseFloat($("latMin").value),
        latMax: parseFloat($("latMax").value),
        lonMin: parseFloat($("lonMin").value),
        lonMax: parseFloat($("lonMax").value),
        variable: $("variable").value,
        temporal: $("temporal").value,
        years: $("years").value.trim(),
        fmt: $("outputFormat").value,
        out: $("outputPath").value.trim(),
      };

      const code = pyTemplate(data);
      $("codeBlock").textContent = code;
      $("status").textContent = "✓ Code generated!";
    }

    // Auto-update output path to match original filename with custom years
    function updateOutputPath() {
      const variable = $("variable").value;
      const temporal = $("temporal").value;
      const fmt = $("outputFormat").value;
      const years = $("years").value.trim();
      
      // Determine year range for filename
      let yearRange = "1960_2019"; // Default
      
      // If years are specified and valid, use those
      if (years && temporal !== "average" && /^\d{4}\s*-\s*\d{4}$/.test(years)) {
        const [start, end] = years.split("-").map(y => y.trim());
        yearRange = `${start}_${end}`;
      }
      
      // Build filename matching the original pattern with appropriate year range
      // Pattern: {variable}_reference_gswp3-w5e5_{temporal}_{yearRange}.{ext}
      const ext = fmt === "zarr" ? "zarr" : "nc";
      const filename = `${variable}_reference_gswp3-w5e5_${temporal}_${yearRange}.${ext}`;
      
      $("outputPath").value = `data/${filename}`;
    }

    // Event listeners
    $("generate").addEventListener("click", generate);
    
    // Update URL when selectors change
    ["datasetType", "variable", "temporal"].forEach(id => {
      $(id).addEventListener("change", updateURL);
    });

    // Auto-update output path (including when years change)
    ["variable", "temporal", "outputFormat", "years"].forEach(id => {
      $(id).addEventListener("change", updateOutputPath);
      $(id).addEventListener("input", updateOutputPath); // Real-time update as user types
    });

    // Initialize
    updateURL();
    updateOutputPath();
  </script>
</body>
</html>
